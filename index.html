<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>취소양식 관리 시스템</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header .team-info {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 1rem;
        }

        .user-info {
            position: absolute;
            top: 1rem;
            right: 1rem;
            text-align: right;
            background: rgba(255,255,255,0.1);
            padding: 0.5rem 1rem;
            border-radius: 10px;
        }

        .user-info .user-name {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .user-info button {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 0.25rem 0.75rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-left: 0.5rem;
            transition: all 0.3s ease;
        }

        .user-info button:hover {
            background: rgba(255,255,255,0.3);
        }

        .admin-controls {
            position: absolute;
            top: 1rem;
            left: 1rem;
        }

        .admin-controls button {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .admin-controls button:hover {
            background: rgba(255,255,255,0.3);
        }

        #adminInfo {
            display: none;
            align-items: center;
            gap: 1rem;
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 5px;
        }

        .filter-section {
            padding: 1.5rem;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 0.95rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }

        .no-permission-msg {
            display: none;
            background: #fff3cd;
            color: #856404;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            border: 1px solid #ffeeba;
            align-items: center;
            gap: 0.5rem;
            margin-left: auto;
        }

        .table-container {
            padding: 1.5rem;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th {
            background: #f8f9fa;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
            color: #212529;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .action-button {
            padding: 0.25rem 0.5rem;
            margin: 0 0.25rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .approve-btn {
            background: #28a745;
            color: white;
        }

        .approve-btn:hover {
            background: #218838;
        }

        .reject-btn {
            background: #dc3545;
            color: white;
        }

        .reject-btn:hover {
            background: #c82333;
        }

        .delete-btn {
            background: #6c757d;
            color: white;
        }

        .delete-btn:hover {
            background: #5a6268;
        }

        .detail-btn {
            background: #17a2b8;
            color: white;
        }

        .detail-btn:hover {
            background: #138496;
        }

        /* 모달 스타일 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 10px 10px 0 0;
            position: relative;
        }

        .modal-header h2 {
            margin: 0;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            background: #f8f9fa;
            border-radius: 0 0 10px 10px;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .close {
            position: absolute;
            right: 1.5rem;
            top: 1.5rem;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            opacity: 0.8;
        }

        .modal-field {
            margin-bottom: 1rem;
        }

        .modal-field label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #495057;
        }

        .modal-field p {
            margin: 0;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 5px;
        }

        /* 토스트 메시지 */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: slideInRight 0.3s;
            z-index: 2000;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-left: 4px solid #28a745;
        }

        .toast.error {
            border-left: 4px solid #dc3545;
        }

        .toast.info {
            border-left: 4px solid #17a2b8;
        }

        /* 체크박스 스타일 */
        .checkbox-cell {
            text-align: center;
        }

        .checkbox-cell input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        #deleteCount {
            background: rgba(255,255,255,0.3);
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.85rem;
        }

        /* 초기 화면 스타일 */
        .welcome-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .welcome-card {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            min-width: 400px;
        }

        .welcome-card h2 {
            color: #495057;
            margin-bottom: 2rem;
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #495057;
            font-weight: 600;
            text-align: left;
        }

        .submit-btn {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        /* 취소사유 열만 특별 처리 */
        td:nth-child(9) {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
            font-size: 0.85rem;
        }

        /* 추가 정보 열도 비슷하게 처리 */
        td:nth-child(10) {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 250px;
        }
    </style>
</head>
<body>
    <!-- 초기 화면 -->
    <div id="welcomeScreen" class="welcome-screen">
        <div class="welcome-card">
            <h2>취소양식 관리 시스템</h2>
            <div class="input-group">
                <label for="userName">이름을 입력하세요</label>
                <input type="text" id="userName" placeholder="예: 홍길동">
            </div>
            <div class="input-group">
                <label for="teamSelect">팀을 선택하세요</label>
                <select id="teamSelect">
                    <option value="">팀 선택...</option>
                    <option value="의정부 SNS팀">의정부 SNS팀</option>
                    <option value="SNS 1팀">SNS 1팀</option>
                    <option value="SNS 2팀">SNS 2팀</option>
                    <option value="SNS 3팀">SNS 3팀</option>
                    <option value="대전마케팅팀">대전마케팅팀</option>
                    <option value="대구마케팅팀">대구마케팅팀</option>
                </select>
            </div>
            <button class="submit-btn" onclick="window.initializeUser()">시작하기</button>
        </div>
    </div>

    <!-- 메인 화면 -->
    <div id="mainScreen" class="container" style="display: none;">
        <div class="header">
            <div class="admin-controls">
                <button id="btnAdminLogin" onclick="window.showAdminLogin()">🔐 관리자 로그인</button>
                <div id="adminInfo">
                    <span>👤 관리자: <strong id="adminName"></strong></span>
                    <button onclick="window.adminLogout()">로그아웃</button>
                </div>
            </div>
            <h1>취소양식 관리 시스템</h1>
            <div class="team-info">
                <span id="currentTeamDisplay"></span>
            </div>
            <div class="user-info">
                <div class="user-name">👤 <span id="currentUserName"></span></div>
                <button onclick="window.changeUserName()">변경</button>
                <button onclick="window.changeTeam()">팀 변경</button>
            </div>
        </div>

        <div class="filter-section">
            <div class="form-group" style="max-width: 150px;">
                <label for="filterDate">날짜 필터</label>
                <input type="date" id="filterDate" onchange="window.loadData()">
            </div>
            <button class="btn btn-secondary" id="btnExportExcel" onclick="window.handleExportExcel()">
                <span>📥</span>
                <span>엑셀 다운로드</span>
            </button>
            <button class="btn btn-danger" id="btnBulkDelete" onclick="window.handleBulkDelete()" style="display: none;">
                <span>🗑️</span>
                <span>선택 삭제</span>
                <span id="deleteCount"></span>
            </button>
            <button class="btn btn-danger" id="btnDeleteAll" onclick="window.handleDeleteAll()" style="display: none; background: linear-gradient(135deg, #991b1b, #7f1d1d);">
                <span>⚠️</span>
                <span>전체 삭제</span>
            </button>
            <button class="btn btn-primary" onclick="window.loadData()">
                <span>🔄</span>
                <span>새로고침</span>
            </button>
            <div class="no-permission-msg" id="noPermissionMsg">
                관리자 권한이 필요합니다
            </div>
        </div>

        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th class="checkbox-cell">
                            <input type="checkbox" id="selectAll" onchange="window.toggleSelectAll()">
                        </th>
                        <th>작성일</th>
                        <th>팀</th>
                        <th>작성시간</th>
                        <th>모집자</th>
                        <th>취소자</th>
                        <th>고객명</th>
                        <th>연락처</th>
                        <th>구분</th>
                        <th>취소사유</th>
                        <th>추가 정보</th>
                        <th>상태</th>
                        <th>작업</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- 데이터가 여기에 동적으로 추가됩니다 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 상세 모달 -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>상세 정보</h2>
                <span class="close" onclick="document.getElementById('detailModal').style.display='none'">&times;</span>
            </div>
            <div class="modal-body" id="detailContent">
                <!-- 상세 내용이 여기에 표시됩니다 -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="document.getElementById('detailModal').style.display='none'">닫기</button>
            </div>
        </div>
    </div>

    <!-- 인증 모달 -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>관리자 인증</h2>
                <span class="close" onclick="window.closeAuthModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="modal-field">
                    <label for="authAdminName">관리자 이름</label>
                    <input type="text" id="authAdminName" placeholder="관리자 이름 입력">
                </div>
                <div class="modal-field">
                    <label for="authPassword">비밀번호</label>
                    <input type="password" id="authPassword" placeholder="비밀번호 입력">
                </div>
                <div class="modal-field">
                    <label>
                        <input type="checkbox" id="saveAuth"> 로그인 유지
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="window.closeAuthModal()">취소</button>
                <button class="btn btn-primary" onclick="window.verifyAdmin()">확인</button>
            </div>
        </div>
    </div>

    <!-- 확인 모달 -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="confirmTitle">확인</h2>
                <span class="close" onclick="window.closeConfirmModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p id="confirmMessage"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="window.closeConfirmModal()">취소</button>
                <button class="btn btn-primary" id="confirmButton">확인</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase 클라이언트 초기화
        const supabaseUrl = 'https://ynyxfpyhmpoepuzozfyt.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlueXhmcHlobXBvZXB1em96Znl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjM2MjU3NTMsImV4cCI6MjAzOTIwMTc1M30.8dSMViCJGnGifDX41s7FbBKVMaQtDpWYVWvQp4VAJzU';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // 전역 변수
        let currentUser = '';
        let currentTeam = '';
        let isAdmin = false;
        let allData = [];
        let selectedItems = new Set();
        let currentAuthAction = null;
        let currentAuthData = null;

        // 팀 이름 간소화 함수
        window.getShortTeamName = function(teamName) {
            if (teamName === '의정부 SNS팀') return '의정부';
            if (teamName && teamName.includes('SNS')) {
                // SNS 1팀 -> 1팀 형식으로 표시
                return teamName.replace('SNS ', '');
            }
            return teamName;
        };

        // 초기화
        window.initializeUser = function() {
            const userName = document.getElementById('userName').value.trim();
            const teamSelect = document.getElementById('teamSelect').value;

            if (!userName) {
                alert('이름을 입력해주세요.');
                return;
            }

            if (!teamSelect) {
                alert('팀을 선택해주세요.');
                return;
            }

            currentUser = userName;
            currentTeam = teamSelect;
            localStorage.setItem('userName', userName);
            localStorage.setItem('userTeam', teamSelect);

            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            document.getElementById('currentUserName').textContent = userName;
            document.getElementById('currentTeamDisplay').textContent = teamSelect;

            // 관리자 상태 확인
            const savedAdminName = localStorage.getItem('adminName');
            const savedAdminPassword = localStorage.getItem('adminPassword');
            
            if (savedAdminName && savedAdminPassword === '1250') {
                isAdmin = true;
                document.getElementById('btnAdminLogin').style.display = 'none';
                document.getElementById('adminInfo').style.display = 'flex';
                document.getElementById('adminName').textContent = savedAdminName;
            }

            window.loadData();
        };

        // 사용자 이름 변경
        window.changeUserName = function() {
            const newName = prompt('새로운 이름을 입력하세요:', currentUser);
            if (newName && newName.trim()) {
                currentUser = newName.trim();
                localStorage.setItem('userName', currentUser);
                document.getElementById('currentUserName').textContent = currentUser;
                window.showToast('이름이 변경되었습니다.', 'success');
            }
        };

        // 팀 변경
        window.changeTeam = function() {
            document.getElementById('welcomeScreen').style.display = 'flex';
            document.getElementById('mainScreen').style.display = 'none';
            document.getElementById('userName').value = currentUser;
        };

        // 관리자 로그인 표시
        window.showAdminLogin = function() {
            document.getElementById('authModal').style.display = 'block';
            document.getElementById('authAdminName').value = '';
            document.getElementById('authPassword').value = '';
            document.getElementById('authAdminName').focus();
        };

        // 관리자 인증
        window.verifyAdmin = function() {
            const name = document.getElementById('authAdminName').value.trim();
            const password = document.getElementById('authPassword').value;
            const saveAuth = document.getElementById('saveAuth').checked;

            if (!name) {
                window.showToast('관리자 이름을 입력해주세요.', 'error');
                return;
            }

            if (password !== '1250') {
                window.showToast('비밀번호가 올바르지 않습니다.', 'error');
                document.getElementById('authPassword').value = '';
                document.getElementById('authPassword').focus();
                return;
            }

            isAdmin = true;
            
            if (saveAuth) {
                localStorage.setItem('adminName', name);
                localStorage.setItem('adminPassword', password);
            }

            document.getElementById('btnAdminLogin').style.display = 'none';
            document.getElementById('adminInfo').style.display = 'flex';
            document.getElementById('adminName').textContent = name;
            
            window.closeAuthModal();
            window.checkPermissions();
            window.showToast(`${name}님 관리자로 로그인되었습니다.`, 'success');

            if (currentAuthAction) {
                window.handleAuthSuccess(name);
            }
        };

        // 관리자 로그아웃
        window.adminLogout = function() {
            if (confirm('관리자 로그아웃 하시겠습니까?')) {
                isAdmin = false;
                localStorage.removeItem('adminName');
                localStorage.removeItem('adminPassword');
                document.getElementById('btnAdminLogin').style.display = 'block';
                document.getElementById('adminInfo').style.display = 'none';
                window.checkPermissions();
                window.showToast('로그아웃되었습니다.', 'info');
            }
        };

        // 모달 닫기
        window.closeAuthModal = function() {
            document.getElementById('authModal').style.display = 'none';
            currentAuthAction = null;
            currentAuthData = null;
        };

        window.closeConfirmModal = function() {
            document.getElementById('confirmModal').style.display = 'none';
        };

        // 인증 성공 후 처리
        window.handleAuthSuccess = function(adminName) {
            if (!currentAuthAction) return;

            switch (currentAuthAction) {
                case 'approve':
                    window.performApprove(currentAuthData, adminName);
                    break;
                case 'reject':
                    window.performReject(currentAuthData, adminName);
                    break;
                case 'delete':
                    window.performDelete(currentAuthData, adminName);
                    break;
            }

            currentAuthAction = null;
            currentAuthData = null;
        };

        // 권한 확인
        window.requireAuth = function(action, data) {
            if (!isAdmin) {
                currentAuthAction = action;
                currentAuthData = data;
                window.showAdminLogin();
                window.showToast('이 작업을 수행하려면 관리자로 로그인해주세요.', 'error');
                return false;
            }
            
            currentAuthAction = action;
            currentAuthData = data;
            
            const adminName = localStorage.getItem('adminName');
            if (adminName) {
                window.handleAuthSuccess(adminName);
            }
            return true;
        };

        // 승인 처리
        window.handleApprove = function(id) {
            window.requireAuth('approve', id);
        };

        window.performApprove = async function(id, adminName) {
            try {
                const { error } = await supabase
                    .from('cancellations')
                    .update({ 
                        status: 'approved',
                        approved_by: adminName,
                        approved_at: new Date().toISOString()
                    })
                    .eq('id', id);

                if (error) throw error;

                window.showToast(`승인되었습니다. (승인자: ${adminName})`, 'success');
                window.loadData();
            } catch (error) {
                window.showToast('승인 처리 실패: ' + error.message, 'error');
            }
        };

        // 거절 처리
        window.handleReject = function(id) {
            window.requireAuth('reject', id);
        };

        window.performReject = async function(id, adminName) {
            try {
                const { error } = await supabase
                    .from('cancellations')
                    .update({ 
                        status: 'rejected',
                        rejected_by: adminName,
                        rejected_at: new Date().toISOString()
                    })
                    .eq('id', id);

                if (error) throw error;

                window.showToast(`거절되었습니다. (거절자: ${adminName})`, 'success');
                window.loadData();
            } catch (error) {
                window.showToast('거절 처리 실패: ' + error.message, 'error');
            }
        };

        // 개별 삭제 처리 (간소화)
        window.handleSingleDelete = async function(id) {
            if (!isAdmin) {
                window.showToast('관리자 권한이 필요합니다.', 'error');
                return;
            }
            
            if (confirm('이 항목을 삭제하시겠습니까?')) {
                try {
                    const { error } = await supabase
                        .from('cancellations')
                        .delete()
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    const adminName = localStorage.getItem('adminName') || '관리자';
                    window.showToast(`삭제되었습니다. (삭제자: ${adminName})`, 'success');
                    window.loadData();
                    
                } catch (error) {
                    window.showToast('삭제 실패: ' + error.message, 'error');
                }
            }
        };

        // 일괄 삭제 처리
        window.handleBulkDelete = async function() {
            if (!isAdmin) {
                window.showToast('관리자 권한이 필요합니다.', 'error');
                return;
            }
            
            if (selectedItems.size === 0) {
                window.showToast('삭제할 항목을 선택해주세요.', 'error');
                return;
            }
            
            const confirmMsg = `정말로 선택한 ${selectedItems.size}개 항목을 삭제하시겠습니까?\n\n⚠️ 경고: 삭제된 데이터는 복구할 수 없습니다!`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            // 두 번째 확인
            const secondConfirm = prompt(`삭제를 진행하려면 "삭제확인"을 입력하세요.`);
            
            if (secondConfirm !== '삭제확인') {
                window.showToast('삭제가 취소되었습니다.', 'info');
                return;
            }
            
            try {
                const itemsArray = Array.from(selectedItems);
                
                // 각 항목 삭제
                for (const id of itemsArray) {
                    const { error } = await supabase
                        .from('cancellations')
                        .delete()
                        .eq('id', id);
                    
                    if (error) throw error;
                }
                
                const adminName = localStorage.getItem('adminName') || '관리자';
                window.showToast(`${selectedItems.size}개 항목이 삭제되었습니다. (삭제자: ${adminName})`, 'success');
                
                // 선택 초기화
                selectedItems.clear();
                const selectAll = document.getElementById('selectAll');
                if (selectAll) selectAll.checked = false;
                updateDeleteButton();
                
                // 데이터 새로고침
                window.loadData();
                
            } catch (error) {
                window.showToast('일괄 삭제 실패: ' + error.message, 'error');
            }
        };

        // 전체 삭제 처리
        window.handleDeleteAll = async function() {
            if (!isAdmin) {
                window.showToast('관리자 권한이 필요합니다.', 'error');
                return;
            }
            
            if (!allData || allData.length === 0) {
                window.showToast('삭제할 데이터가 없습니다.', 'error');
                return;
            }
            
            // 필터 상태 확인
            const dateFilter = document.getElementById('filterDate').value;
            const isFiltered = dateFilter !== '';
            
            // 전체 데이터 개수 확인
            let totalCount = allData.length;
            let deleteMessage = '';
            
            if (isFiltered) {
                deleteMessage = `현재 필터링된 ${totalCount}개의 데이터를 삭제하시겠습니까?`;
            } else {
                deleteMessage = `${currentTeam}의 모든 ${totalCount}개 데이터를 삭제하시겠습니까?`;
            }
            
            const confirmMsg = `⚠️⚠️ 경고 ⚠️⚠️\n\n${deleteMessage}\n\n이 작업은 되돌릴 수 없습니다!`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            // 두 번째 확인
            const secondConfirm = prompt(`정말로 모든 데이터를 삭제하시겠습니까?\n\n최종 확인을 위해 "전체삭제확인"을 입력하세요.`);
            
            if (secondConfirm !== '전체삭제확인') {
                window.showToast('전체 삭제가 취소되었습니다.', 'info');
                return;
            }
            
            // 세 번째 확인
            const finalConfirm = confirm(`⚠️ 최종 경고!\n\n${totalCount}개의 모든 데이터가 영구적으로 삭제됩니다.\n정말 진행하시겠습니까?`);
            
            if (!finalConfirm) {
                window.showToast('전체 삭제가 취소되었습니다.', 'info');
                return;
            }
            
            try {
                // 삭제할 데이터 결정
                let dataToDelete = allData;
                
                // 각 항목 삭제
                for (const item of dataToDelete) {
                    const { error } = await supabase
                        .from('cancellations')
                        .delete()
                        .eq('id', item.id);
                    
                    if (error) throw error;
                }
                
                const adminName = localStorage.getItem('adminName') || '관리자';
                window.showToast(`전체 ${dataToDelete.length}개 항목이 삭제되었습니다. (삭제자: ${adminName})`, 'success');
                
                // 선택 초기화
                selectedItems.clear();
                const selectAll = document.getElementById('selectAll');
                if (selectAll) selectAll.checked = false;
                updateDeleteButton();
                
                // 데이터 새로고침
                window.loadData();
                
            } catch (error) {
                window.showToast('전체 삭제 실패: ' + error.message, 'error');
            }
        };

        // 체크박스 전체 선택/해제
        window.toggleSelectAll = function() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.item-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
                const id = parseInt(checkbox.dataset.id);
                if (selectAll.checked) {
                    selectedItems.add(id);
                } else {
                    selectedItems.delete(id);
                }
            });
            
            updateDeleteButton();
        };

        // 개별 체크박스 토글
        window.toggleItemSelection = function(id) {
            const checkbox = document.querySelector(`.item-checkbox[data-id="${id}"]`);
            if (checkbox.checked) {
                selectedItems.add(id);
            } else {
                selectedItems.delete(id);
            }
            
            // 전체 선택 체크박스 업데이트
            const allCheckboxes = document.querySelectorAll('.item-checkbox');
            const selectAll = document.getElementById('selectAll');
            selectAll.checked = selectedItems.size === allCheckboxes.length && allCheckboxes.length > 0;
            
            updateDeleteButton();
        };

        // 삭제 버튼 업데이트
        function updateDeleteButton() {
            const deleteBtn = document.getElementById('btnBulkDelete');
            const deleteCount = document.getElementById('deleteCount');
            
            if (selectedItems.size > 0) {
                deleteCount.textContent = `(${selectedItems.size})`;
            } else {
                deleteCount.textContent = '';
            }
        }

        // 권한 체크 및 UI 업데이트
        window.checkPermissions = function() {
            const exportBtn = document.getElementById('btnExportExcel');
            const bulkDeleteBtn = document.getElementById('btnBulkDelete');
            const deleteAllBtn = document.getElementById('btnDeleteAll');
            const noPermissionMsg = document.getElementById('noPermissionMsg');
            
            if (isAdmin) {
                exportBtn.style.display = 'inline-flex';
                bulkDeleteBtn.style.display = 'inline-flex';
                deleteAllBtn.style.display = 'inline-flex';
                noPermissionMsg.style.display = 'none';
                document.querySelectorAll('.action-button').forEach(btn => {
                    btn.style.display = 'inline-block';
                });
                // 체크박스 열 표시
                document.querySelector('th:first-child').style.display = 'table-cell';
                document.querySelectorAll('td:first-child').forEach(td => {
                    td.style.display = 'table-cell';
                });
            } else {
                exportBtn.style.display = 'none';
                bulkDeleteBtn.style.display = 'none';
                deleteAllBtn.style.display = 'none';
                noPermissionMsg.style.display = 'flex';
                document.querySelectorAll('.action-button').forEach(btn => {
                    btn.style.display = 'none';
                });
                // 체크박스 열 숨기기
                document.querySelector('th:first-child').style.display = 'none';
                document.querySelectorAll('td:first-child').forEach(td => {
                    td.style.display = 'none';
                });
            }
        };

        // 데이터 로드
        window.loadData = async function() {
            try {
                let query = supabase
                    .from('cancellations')
                    .select('*')
                    .eq('team', currentTeam)
                    .order('created_at', { ascending: false });

                const filterDate = document.getElementById('filterDate').value;
                if (filterDate) {
                    const startDate = new Date(filterDate);
                    startDate.setHours(0, 0, 0, 0);
                    const endDate = new Date(filterDate);
                    endDate.setHours(23, 59, 59, 999);

                    query = query
                        .gte('created_at', startDate.toISOString())
                        .lte('created_at', endDate.toISOString());
                }

                const { data, error } = await query;

                if (error) throw error;

                allData = data || [];
                displayData(allData);
                window.checkPermissions();

            } catch (error) {
                console.error('데이터 로드 실패:', error);
                window.showToast('데이터를 불러오는데 실패했습니다.', 'error');
            }
        };

        // 데이터 표시
        function displayData(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="13" style="text-align: center; padding: 2rem;">데이터가 없습니다.</td></tr>';
                return;
            }

            data.forEach(item => {
                const date = new Date(item.created_at);
                const dateStr = date.toLocaleDateString('ko-KR');
                const timeStr = date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                
                const statusClass = item.status === 'approved' ? 'status-approved' : 
                                  item.status === 'rejected' ? 'status-rejected' : 'status-pending';
                const statusText = item.status === 'approved' ? '승인' : 
                                 item.status === 'rejected' ? '거절' : '대기';

                // 팀 이름을 간소화
                const shortTeamName = window.getShortTeamName(item.team);

                // CRM 입력 메시지 처리
                const crmText = item.crm_input || '-';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="checkbox-cell">
                        <input type="checkbox" class="item-checkbox" data-id="${item.id}" onchange="window.toggleItemSelection(${item.id})">
                    </td>
                    <td>${dateStr}</td>
                    <td>${shortTeamName}</td>
                    <td>${timeStr}</td>
                    <td>${item.recruiter}</td>
                    <td>${item.canceller}</td>
                    <td>${item.customer_name}</td>
                    <td>${item.customer_phone}</td>
                    <td>${item.category || '-'}</td>
                    <td title="${crmText.replace(/"/g, '&quot;')}">${crmText.replace(/\n/g, ' ')}</td>
                    <td>${item.additional_info || '-'}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>
                        <button class="action-button detail-btn" onclick="window.showDetail(${item.id})">상세</button>
                        <button class="action-button approve-btn" onclick="window.handleApprove(${item.id})">승인</button>
                        <button class="action-button reject-btn" onclick="window.handleReject(${item.id})">거절</button>
                        <button class="action-button delete-btn" onclick="window.handleSingleDelete(${item.id})">삭제</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // 선택 상태 초기화
            selectedItems.clear();
            document.getElementById('selectAll').checked = false;
            updateDeleteButton();
        }

        // 상세 정보 표시
        window.showDetail = function(id) {
            const item = allData.find(d => d.id === id);
            if (!item) return;

            const date = new Date(item.created_at);
            const content = `
                <div class="modal-field">
                    <label>작성일시</label>
                    <p>${date.toLocaleString('ko-KR')}</p>
                </div>
                <div class="modal-field">
                    <label>팀</label>
                    <p>${item.team}</p>
                </div>
                <div class="modal-field">
                    <label>모집자</label>
                    <p>${item.recruiter}</p>
                </div>
                <div class="modal-field">
                    <label>취소자</label>
                    <p>${item.canceller}</p>
                </div>
                <div class="modal-field">
                    <label>고객명</label>
                    <p>${item.customer_name}</p>
                </div>
                <div class="modal-field">
                    <label>연락처</label>
                    <p>${item.customer_phone}</p>
                </div>
                <div class="modal-field">
                    <label>구분</label>
                    <p>${item.category || '-'}</p>
                </div>
                <div class="modal-field">
                    <label>CRM 입력 메시지</label>
                    <p style="white-space: pre-wrap;">${item.crm_input || '-'}</p>
                </div>
                <div class="modal-field">
                    <label>추가 정보</label>
                    <p>${item.additional_info || '-'}</p>
                </div>
                <div class="modal-field">
                    <label>상태</label>
                    <p>${item.status === 'approved' ? '승인' : item.status === 'rejected' ? '거절' : '대기'}</p>
                </div>
                ${item.approved_by ? `
                <div class="modal-field">
                    <label>승인자</label>
                    <p>${item.approved_by} (${new Date(item.approved_at).toLocaleString('ko-KR')})</p>
                </div>
                ` : ''}
                ${item.rejected_by ? `
                <div class="modal-field">
                    <label>거절자</label>
                    <p>${item.rejected_by} (${new Date(item.rejected_at).toLocaleString('ko-KR')})</p>
                </div>
                ` : ''}
            `;

            document.getElementById('detailContent').innerHTML = content;
            document.getElementById('detailModal').style.display = 'block';
        };

        // 엑셀 다운로드
        window.handleExportExcel = function() {
            if (!isAdmin) {
                window.showToast('관리자 권한이 필요합니다.', 'error');
                return;
            }

            if (allData.length === 0) {
                window.showToast('다운로드할 데이터가 없습니다.', 'error');
                return;
            }

            try {
                const excelData = allData.map(item => {
                    const date = new Date(item.created_at);
                    return {
                        '작성일': date.toLocaleDateString('ko-KR'),
                        '작성시간': date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }),
                        '팀': item.team,
                        '모집자': item.recruiter,
                        '취소자': item.canceller,
                        '고객명': item.customer_name,
                        '연락처': item.customer_phone,
                        '구분': item.category || '',
                        'CRM 입력 메시지': item.crm_input || '',
                        '추가 정보': item.additional_info || '',
                        '상태': item.status === 'approved' ? '승인' : item.status === 'rejected' ? '거절' : '대기',
                        '승인자': item.approved_by || '',
                        '승인일시': item.approved_at ? new Date(item.approved_at).toLocaleString('ko-KR') : '',
                        '거절자': item.rejected_by || '',
                        '거절일시': item.rejected_at ? new Date(item.rejected_at).toLocaleString('ko-KR') : ''
                    };
                });

                const ws = XLSX.utils.json_to_sheet(excelData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '취소양식');

                const fileName = `취소양식_${currentTeam}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                const adminName = localStorage.getItem('adminName') || '관리자';
                window.showToast(`엑셀 다운로드 완료 (다운로드: ${adminName})`, 'success');

            } catch (error) {
                window.showToast('엑셀 다운로드 실패: ' + error.message, 'error');
            }
        };

        // 토스트 메시지
        window.showToast = function(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${type === 'success' ? '✓' : type === 'error' ? '✗' : 'ℹ'}</span>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };

        // 페이지 로드 시 초기화
        window.onload = function() {
            const savedUserName = localStorage.getItem('userName');
            const savedTeam = localStorage.getItem('userTeam');

            if (savedUserName && savedTeam) {
                currentUser = savedUserName;
                currentTeam = savedTeam;
                document.getElementById('userName').value = savedUserName;
                document.getElementById('teamSelect').value = savedTeam;
                window.initializeUser();
            }

            // Enter 키 이벤트 리스너
            document.getElementById('userName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    window.initializeUser();
                }
            });

            document.getElementById('authPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    window.verifyAdmin();
                }
            });

            // 모달 외부 클릭시 닫기
            window.onclick = function(event) {
                const detailModal = document.getElementById('detailModal');
                const authModal = document.getElementById('authModal');
                const confirmModal = document.getElementById('confirmModal');
                
                if (event.target === detailModal) {
                    detailModal.style.display = 'none';
                }
                if (event.target === authModal) {
                    window.closeAuthModal();
                }
                if (event.target === confirmModal) {
                    window.closeConfirmModal();
                }
            };
        };
    </script>
</body>
</html>
